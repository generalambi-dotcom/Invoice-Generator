// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    // Hashed password
  isAdmin       Boolean   @default(false)
  publicSlug    String?   @unique // Public username/slug for invoice links (e.g., "company-name")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Email verification
  emailVerified              Boolean   @default(false)
  emailVerificationToken     String?   @unique
  emailVerificationExpiry    DateTime?

  // Password reset
  resetToken    String?   @unique
  resetTokenExpiry DateTime?

  // Account lockout
  failedLoginAttempts        Int       @default(0)
  lockedUntil                DateTime?

  // Subscription
  subscriptionPlan    String?   // 'free' | 'premium'
  subscriptionStatus  String?   // 'active' | 'cancelled' | 'expired'
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  subscriptionPaymentMethod String? // 'paypal' | 'paystack' | 'stripe'

  // Relations
  paymentCredentials PaymentCredential[]
  invoices          Invoice[]
  payments          Payment[]
  sentEmails        EmailLog[]
  refreshTokens     RefreshToken[]
  companyDefaults   CompanyDefaults?
  clients           Client[]
  invoiceNumberSequences InvoiceNumberSequence[]
}

model PaymentCredential {
  id        String   @id @default(cuid())
  userId    String
  provider  String   // 'paypal' | 'paystack' | 'stripe'
  
  // Encrypted credentials
  publicKey    String?  // For Paystack/Stripe public keys
  secretKey    String?  // Encrypted secret keys
  clientId     String?  // For PayPal
  clientSecret String?  // For PayPal (encrypted)
  
  // Additional config
  isActive     Boolean  @default(true)
  isTestMode  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

model Invoice {
  id            String   @id @default(cuid())
  userId        String
  invoiceNumber String
  invoiceDate   DateTime
  dueDate       DateTime
  purchaseOrder String?
  
  // Company info (JSON)
  companyInfo   Json
  
  // Client info (JSON)
  clientId      String?  // Reference to Client model (optional for backward compatibility)
  clientInfo    Json
  shipToInfo    Json?
  
  // Line items (JSON array)
  lineItems     Json
  
  // Totals
  subtotal      Float
  taxRate       Float    @default(0)
  taxAmount     Float    @default(0)
  discountRate  Float    @default(0)
  discountAmount Float   @default(0)
  shipping      Float    @default(0)
  total         Float
  
  currency      String   @default("USD")
  theme         String   @default("slate")
  
  notes         String?
  bankDetails   String?
  terms         String?
  
  // Payment info
  paymentStatus String   @default("pending") // 'pending' | 'paid' | 'overdue' | 'cancelled'
  paymentLink    String?
  paymentProvider String? // 'paypal' | 'paystack' | 'stripe'
  paidAmount    Float?   @default(0)
  paymentDate   DateTime?
  
  // Invoice source tracking
  createdBy     String?  // 'owner' | 'customer' - who created this invoice
  customerEmail String?  // Email of customer who created (if customer-created)
  
  // Email tracking
  sentAt        DateTime?
  viewedAt      DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  client        Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  payments      Payment[]

  @@index([userId])
  @@index([invoiceNumber])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([clientId])
}

model Payment {
  id            String   @id @default(cuid())
  invoiceId     String
  userId        String
  amount        Float
  currency      String   @default("USD")
  provider      String   // 'paypal' | 'paystack' | 'stripe'
  
  // Payment details
  transactionId String?  @unique
  reference     String?  @unique
  status        String   // 'pending' | 'completed' | 'failed' | 'refunded'
  
  // Provider-specific data (JSON)
  providerData  Json?
  
  paidAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model EmailLog {
  id            String   @id @default(cuid())
  userId        String
  invoiceId     String?
  to            String
  subject       String
  body          String
  status        String   // 'sent' | 'failed' | 'bounced'
  errorMessage  String?
  sentAt        DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
  @@index([sentAt])
}

model RefreshToken {
  id            String   @id @default(cuid())
  userId        String
  token         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  revokedAt     DateTime?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model CompanyDefaults {
  id                String   @id @default(cuid())
  userId            String   @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Company information (JSON)
  companyInfo       Json
  
  // Default settings
  defaultCurrency        String   @default("USD")
  defaultTheme           String   @default("slate")
  defaultTaxRate         Float    @default(0)
  defaultNotes           String?
  defaultBankDetails     String?
  defaultTerms           String?
  defaultPaymentProvider String?  // 'paypal' | 'paystack' | 'stripe'

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Client {
  id            String   @id @default(cuid())
  userId        String
  name          String
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zip           String?
  country       String?
  website       String?
  notes         String?
  tags          String[]  @default([])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices      Invoice[]

  @@index([userId])
  @@index([email])
  @@index([name])
}

model InvoiceNumberSequence {
  id            String   @id @default(cuid())
  userId        String
  prefix        String   @default("INV")
  format        String   @default("PREFIX-YYYY-NNNN") // PREFIX-YYYY-NNNN, PREFIX-NNNN, etc.
  currentNumber Int      @default(1)
  year          Int?     // For year-based sequences
  month         Int?     // For month-based sequences
  resetPeriod   String?  // 'year' | 'month' | null (never reset)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, prefix, year, month])
  @@index([userId])
  @@index([prefix])
}
